name: Generate SEO Content (DeepSeek)

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ð°Ñ‚ÐµÐ¹ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸'
        required: false
        default: '1'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      BATCH_SIZE: ${{ github.event.inputs.batch_size || 1 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci

      - name: Debug environment
        run: |
          echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°"
          echo "ðŸ”‘ API ÐºÐ»ÑŽÑ‡ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: ${{ secrets.DEEPSEEK_API_KEY != '' }}"
          if [ -n "${DEEPSEEK_API_KEY}" ]; then
            echo "ðŸ“ Ð”Ð»Ð¸Ð½Ð° ÐºÐ»ÑŽÑ‡Ð°: ${#DEEPSEEK_API_KEY} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          fi
          echo "ðŸ“Š Batch size: $BATCH_SIZE"

      - name: Check project structure
        run: |
          echo "ðŸ“ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°:"
          pwd
          ls -la
          echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ src:"
          ls -la src/ 2>/dev/null || echo "ÐÐµÑ‚ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ src"
          echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ src/content:"
          ls -la src/content/ 2>/dev/null || echo "ÐÐµÑ‚ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ src/content"
          echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ src/content/posts:"
          ls -la src/content/posts/ 2>/dev/null || echo "ÐÐµÑ‚ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ src/content/posts"

      - name: Check topics file
        run: |
          if [ ! -f "topics.txt" ]; then
            echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ topics.txt"
            echo "Ð¢ÐµÑÑ‚Ð¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚ÑŒÑ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸" > topics.txt
          fi
          echo "ðŸ“‹ Ð¢ÐµÐ¼Ñ‹ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸:"
          cat topics.txt

      - name: Run DeepSeek content factory
        run: |
          echo "ðŸ¤– Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ Ñ‡ÐµÑ€ÐµÐ· DeepSeek..."
          npm run factory

      - name: Check generated files
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹..."
          echo "ðŸ“ Ð’ÑÐµ .md Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ:"
          find . -name "*.md" | head -10
          echo "ðŸ“ Ð¤Ð°Ð¹Ð»Ñ‹ Ð² src/content/posts:"
          ls -la src/content/posts/ 2>/dev/null || echo "ÐÐµÑ‚ Ñ„Ð°Ð¹Ð»Ð¾Ð²"

      - name: Commit and push generated content
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ ÑÑ‚Ð°Ñ‚ÑƒÑ Git:"
          git status
          
          if ! git diff --staged --quiet || ! git diff --quiet; then
            echo "ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑŽ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ..."
            git add .
            git commit -m "Generate SEO content with DeepSeek [skip ci]"
            git push
            echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½!"
          else
            echo "â„¹ï¸ ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸"
            echo "ðŸ” ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°:"
            git status --porcelain
          fi

      - name: Completion summary
        if: always()
        run: |
          echo "## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· 1-2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹" >> $GITHUB_STEP_SUMMARY
