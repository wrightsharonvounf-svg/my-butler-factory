name: Generate SEO Content (DeepSeek)

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ð°Ñ‚ÐµÐ¹ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸'
        required: false
        default: '1'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      BATCH_SIZE: ${{ github.event.inputs.batch_size || 1 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci

      - name: Debug environment
        run: |
          echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°"
          echo "ðŸ”‘ API ÐºÐ»ÑŽÑ‡ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: ${{ secrets.DEEPSEEK_API_KEY != '' }}"
          echo "ðŸ“Š Batch size: $BATCH_SIZE"

      - name: Check topics file
        run: |
          if [ ! -f "topics.txt" ]; then
            echo "Ð¢ÐµÑÑ‚Ð¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚ÑŒÑ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸" > topics.txt
          fi

      - name: Run DeepSeek content factory
        run: |
          npm run factory

      - name: Commit and push generated content
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ ÑÑ‚Ð°Ñ‚ÑƒÑ Git:"
          git status
          
          # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ .md Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· posts
          echo "ðŸ’¾ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÑŽ Ð½Ð¾Ð²Ñ‹Ðµ ÑÑ‚Ð°Ñ‚ÑŒÐ¸..."
          find src/content/posts -name "*.md" -type f 2>/dev/null | while read file; do
            if [ -f "$file" ]; then
              echo "Ð”Ð¾Ð±Ð°Ð²Ð»ÑÑŽ: $file"
              git add "$file"
            fi
          done
          
          # ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± - Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÑÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
          git add src/content/posts/ 2>/dev/null || echo "ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² posts"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ñ‚ÑŒ
          if ! git diff --staged --quiet; then
            echo "ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑŽ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ..."
            git commit -m "Generate SEO content with DeepSeek [skip ci]"
            git push
            echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½!"
          else
            echo "â„¹ï¸ ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸"
          fi

      - name: Completion summary
        if: always()
        run: |
          echo "## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· 1-2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹" >> $GITHUB_STEP_SUMMARY
