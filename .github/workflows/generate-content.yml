name: Auto Generate & Deploy

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'  # Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² 09:00 UTC (12:00 MSK)

permissions:
  contents: write

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
          npm install
          echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

      - name: Debug environment
        run: |
          echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸"
          echo "ðŸ”‘ API ÐºÐ»ÑŽÑ‡: ${{ secrets.DEEPSEEK_API_KEY != '' }}"
          echo "ðŸ“… Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°: $(date)"

      - name: Check topics
        run: |
          if [ ! -f "topics.txt" ]; then
            echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ topics.txt"
            echo "ÐšÐ°Ðº Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒ" > topics.txt
            echo "Ð ÐµÐ¼Ð¾Ð½Ñ‚ Ð´Ð²Ð¸Ð³Ð°Ñ‚ÐµÐ»Ñ" >> topics.txt
            echo "Ð­ÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ Ñ‚Ð¾Ð¿Ð»Ð¸Ð²Ð°" >> topics.txt
          fi
          echo "ðŸ“‹ Ð¢ÐµÐ¼Ñ‹ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸:"
          head -5 topics.txt

      - name: Generate content
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ðŸ¤– Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°..."
          node factory.js
          echo "âœ… Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"

      - name: Deploy to GitHub Pages
        run: |
          echo "ðŸ“¤ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð´ÐµÐ¿Ð»Ð¾Ð¹..."
          
          # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git add .
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ñ‚ÑŒ
          if ! git diff --staged --quiet; then
            echo "ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑŽ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ..."
            git commit -m "Auto-generate content $(date +%Y-%m-%d)"
            git push
            echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½!"
            echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· 1-2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹"
          else
            echo "â„¹ï¸ ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸"
          fi

      - name: Completion summary
        if: always()
        run: |
          echo "## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚: https://kovric.store/blog/" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº: Ð·Ð°Ð²Ñ‚Ñ€Ð° Ð² 12:00 MSK" >> $GITHUB_STEP_SUMMARY
