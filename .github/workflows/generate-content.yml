name: Generate SEO Content (DeepSeek)

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ð°Ñ‚ÐµÐ¹ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸'
        required: false
        default: '1'
  schedule:
    - cron: '0 3 * * *'  # Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² 03:00 UTC

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      BATCH_SIZE: ${{ github.event.inputs.batch_size || 1 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci

      - name: Debug environment
        run: |
          echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°"
          echo "ðŸ”‘ API ÐºÐ»ÑŽÑ‡ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: ${{ secrets.DEEPSEEK_API_KEY != '' }}"
          if [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
            echo "ðŸ“ Ð”Ð»Ð¸Ð½Ð° ÐºÐ»ÑŽÑ‡Ð°: ${#{{ secrets.DEEPSEEK_API_KEY }}} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          fi
          echo "ðŸ“Š Batch size: $BATCH_SIZE"

      - name: Check topics file
        run: |
          if [ ! -f "topics.txt" ]; then
            echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ topics.txt"
            echo "Ð¢ÐµÑÑ‚Ð¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚ÑŒÑ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸" > topics.txt
            echo "ÐŸÑ€Ð¸Ð¼ÐµÑ€ SEO ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°" >> topics.txt
          fi
          echo "ðŸ“‹ Ð¢ÐµÐ¼Ñ‹ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸:"
          head -5 topics.txt

      - name: Run DeepSeek content factory
        run: |
          echo "ðŸ¤– Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ Ñ‡ÐµÑ€ÐµÐ· DeepSeek..."
          npm run factory

      - name: Commit and push generated content
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          if ! git diff --staged --quiet || ! git diff --quiet; then
            echo "ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑŽ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ..."
            git add .
            git commit -m "Generate SEO content with DeepSeek [skip ci]"
            git push
            echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½!"
            echo "ðŸ”„ GitHub Pages Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿ÐµÑ€ÐµÑÐ¾Ð±ÐµÑ€ÐµÑ‚ ÑÐ°Ð¹Ñ‚"
          else
            echo "â„¹ï¸ ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸"
          fi

      - name: Trigger site rebuild
        if: success()
        run: |
          echo "ðŸ” Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð¿ÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ¸ ÑÐ°Ð¹Ñ‚Ð°..."
          git commit --allow-empty -m "Trigger site rebuild [skip ci]" 2>/dev/null || true
          git push 2>/dev/null || true

      - name: Completion summary
        if: always()
        run: |
          echo "## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· 1-2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð¾Ð²Ñ‹Ðµ ÑÑ‚Ð°Ñ‚ÑŒÐ¸ Ð² Ð±Ð»Ð¾Ð³Ðµ" >> $GITHUB_STEP_SUMMARY
